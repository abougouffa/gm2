#!/bin/sh

# Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008,
#               2009
# Free Software Foundation, Inc.
# This file is part of GNU Modula-2.
#
# GNU Modula-2 is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3, or (at your option)
# any later version.
# 
# GNU Modula-2 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with GNU Modula-2; see the file COPYING.  If not, write to the
# Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston, MA
# 02110-1301, USA. 
#


#
# makeversion a script which creates M2Version implementation
#             module or C file for the GNU Modula-2 compiler
#



function doM2 () {
/bin/rm -f M2Version.mod

cat << EOF >> M2Version.mod
IMPLEMENTATION MODULE M2Version ;

FROM DynamicStrings IMPORT InitString, Mark, Slice ;


(* Generated by makeversion - do not edit *)

PROCEDURE GetGM2Version () : String ;
BEGIN
   RETURN InitString('${GM2VERSION}')
END GetGM2Version ;


PROCEDURE GetGM2Date () : String ;
BEGIN
   RETURN InitString("`date '+%Y%m%d'`")
END GetGM2Date ;


PROCEDURE GetGCCVersion () : String ;
BEGIN
   RETURN InitString('${GCCVERSION}')
END GetGCCVersion ;


PROCEDURE GetYear () : String ;
VAR
   s: String ;
BEGIN
   RETURN Slice(Mark(InitString(__DATE__)), -4, 0)
END GetYear ;


END M2Version.
EOF
}


function doC () {

cat <<EOF > gm2version.c
/* Generated by makeversion - do not edit */
#include "config.h"
#include "system.h"

void gm2_version (void);

void gm2_version (void)
{
   printf("GNU Modula-2  ${GM2VERSION}  (`date '+%Y%m%d'`)\n");
   printf("  grafted onto GCC ${GCCVERSION}\n");
   printf("Copyright (C) `date '+%Y'` Free Software Foundation, Inc.\n");
   printf("License GPLv2: GNU GPL version 2 or later <http://gnu.org/licenses/gpl.html>\n") ;
   printf("This is free software: you are free to change and redistribute it.\n") ;
   printf("There is NO WARRANTY, to the extent permitted by law.\n") ;
   exit(0);
}
EOF
}


function doTexi () {

cat <<EOF > version.texi

@c Generated by makeversion - do not edit

@set version-GM2     ${GM2VERSION}
@set version-GCC     ${GCCVERSION}
@set version-update  ${TEXIUPDATE}

EOF
}


progname=$0

function usage () {
   cat <<EOF
Usage: $progname [-m][-c][-t] 
   -m  generates a Modula-2 module M2Version.mod
   -c  generates a C file gm2version.c
   -t  generates a texi file version.texi
EOF
   exit 0
}

M2=no
C=no
TEXI=no

while getopts ":mcht" opt; do
   case $opt in

   m )  M2=yes ;;
   c )  C=yes ;;
   t )  TEXI=yes ;;
   h )  usage ;;
   \\?) usage ;;
   esac
done

shift $(($OPTIND - 1))

SRCDIR=$1
GM2VERSION=`cat ${SRCDIR}/gm2/version.c | sed -e '/version_string/!d' -e 's/[^0-9.]*\([0-9.]*\).*/\1/g'`
GCCVERSION=`echo ${SRCDIR} | sed 's/.*gcc-\([0-9][0-9.]*\).*/\1/g'`

pos=`grep -n texi ${SRCDIR}/gm2/ChangeLog | head -1 | cut -f1 -d':'`
THEDATE=`head -n ${pos} ${SRCDIR}/gm2/ChangeLog | grep ^2 | head -1 | cut -f1 -d' ' | cut -f1`

if date --date=${THEDATE} +'%A %e %B %Y' > /dev/null 2>&1 ; then
    #
    #  GNU date
    #
    TEXIUPDATE=`date --date=${THEDATE} +'%A %e %B %Y'`
elif date -j -f "%Y-%m-%d" ${THEDATE} +"%d %b %Y" > /dev/null 2>&1 ; then
    #
    #  assuming FreeBSD date
    #
    TEXIUPDATE=`date -j -f "%Y-%m-%d" ${THEDATE} +"%d %b %Y"`
else
    #
    #  no idea - so we just use the date in ChangeLog format
    #
    TEXIUPDATE=${THEDATE}
fi

if [ "${M2}" = "yes" ] ; then
   doM2
elif [ "${C}" = "yes" ] ; then
   doC
elif [ "${TEXI}" = "yes" ] ; then
   doTexi
else
   usage
fi

#
#  now we test the consistency of the release number in
#  $(srcdir)/gm2/gm2-libs/config-host.in
#

if [ "`grep AC_INIT ${SRCDIR}/gm2/gm2-libs/config-host.in | grep ${GM2VERSION}`" == "" ] ; then
   echo "makeversion has found a consistency error:  the ${SRCDIR}/gm2/gm2-libs/config-host.in does not match the GNU Modula-2 release number"
   exit 1
fi

if [ "`grep AC_INIT ${SRCDIR}/gm2/gm2-libs/config-target.in | grep ${GM2VERSION}`" == "" ] ; then
   echo "makeversion has found a consistency error:  the ${SRCDIR}/gm2/gm2-libs/config-target.in does not match the GNU Modula-2 release number"
   exit 1
fi
